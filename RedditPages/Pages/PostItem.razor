@page "/post/{id}"

@using redditpages.Data;
@using shared.Model;
@inject ApiService apiService
@inject NavigationManager NavigationManager

<PageTitle>Reddot</PageTitle>

<head>
    <link href="css/app.css" rel="stylesheet" />
</head>

<button @onclick="NavigateToAllPosts">Tilbage til alle posts</button>
@if (Post == null)
{
    <p><em>Loading...</em></p>
    // Viser loading-indikator, mens data indlæses
}
else
{
    <div class="contents">
        <h4>@Post.Title</h4>
        <p><strong>User: @Post.User, Votes: @(Post.Upvotes - Post.Downvotes)</strong></p>
        <p>@Post.Content</p>
        <p><em>Created At: @FormatTimeSince(Post.CreatedAt)</em></p>
        <button @onclick="() => UpvotePost(Post.Id)">Upvote Post</button>
        <button @onclick="() => DownvotePost(Post.Id)">Downvote Post</button>
    </div>

    <div class="contents">
        <h4>Comments</h4>
        <table>
            <tr>
                <th>User</th>
                <th>Comment</th>
                <th>Votes</th>
                <th>Created At</th>
                <th colspan="2">Actions</th>
            </tr>
            @foreach (var comment in Post.Comments.OrderByDescending(c => c.CreatedAt))
            {
                <tr>
                    <td>@comment.User</td>
                    <td>@comment.Content</td>
                    <td>@(comment.Upvotes - comment.Downvotes)</td>
                    <td>@FormatTimeSince(comment.CreatedAt)</td>
                    <td><button @onclick="() => UpvoteComment(comment.Id)">Upvote</button></td>
                    <td><button @onclick="() => DownvoteComment(comment.Id)">Downvote</button></td>
                </tr>
            }
        </table>
    </div>

    <CreateComment PostId="@PostId" RefreshComments="LoadComments"></CreateComment>
}

@code {
    [Parameter]
    public string Id { get; set; }
    public int PostId { get { return int.Parse(Id); } }
    public Post Post { get; set; }

    // Indlæser kommentarer og post-data ved initialisering
    protected override async Task OnInitializedAsync()
    {
        await LoadComments();
    }

    // Indlæser post-data og kommentarer
    private async Task LoadComments()
    {
        Post = await apiService.GetPost(PostId);
        StateHasChanged();
    }

    // Håndterer opstemning af post
    private async Task UpvotePost(int postId)
    {
        await apiService.UpvotePost(postId);
        await RefreshPost();
    }

    // Håndterer nedstemning af post
    private async Task DownvotePost(int postId)
    {
        await apiService.DownvotePost(postId);
        await RefreshPost();
    }

    // Håndterer opstemning af kommentar
    private async Task UpvoteComment(int commentId)
    {
        await apiService.UpvoteComment(commentId);
        await RefreshPost();
    }

    // Håndterer nedstemning af kommentar
    private async Task DownvoteComment(int commentId)
    {
        await apiService.DownvoteComment(commentId);
        await RefreshPost();
    }

    // Opdaterer post-data efter ændringer
    private async Task RefreshPost()
    {
        await LoadComments();
    }

    // Navigerer tilbage til alle posts
    private void NavigateToAllPosts()
    {
        NavigationManager.NavigateTo("/");
    }

    // Formaterer tid siden oprettelse af post/comment
    private string FormatTimeSince(DateTime createdAt)
    {
        var timeSpan = DateTime.Now - createdAt;

        if (timeSpan.TotalDays >= 1)
        {
            return $"{(int)timeSpan.TotalDays} days ago";
        }
        else if (timeSpan.TotalHours >= 1)
        {
            return $"{(int)timeSpan.TotalHours} hours ago";
        }
        else
        {
            return $"{(int)timeSpan.TotalMinutes} minutes ago";
        }
    }
}
