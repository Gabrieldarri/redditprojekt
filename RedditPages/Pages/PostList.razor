@inherits LayoutComponentBase

@using redditpages.Data;
@using shared.Model;
@inject ApiService apiService

<head>
    <link href="css/app.css" rel="stylesheet" />
</head>

@if (posts == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <h3>Add a New Post</h3>
    <input placeholder="Title" type="text" @bind="newPostTitle" />
    <textarea placeholder="Content" @bind="newPostContent"></textarea>
    <input placeholder="Username" type="text" @bind="newPostUser" />
    <button @onclick="CreatePost">Create Post</button>

    <div>
        <label for="sortOptions">Sort by:</label>
        <select id="sortOptions" @onchange="OnSortOptionChanged">
            <option value="newest">Newest</option>
            <option value="mostVotes">Most Votes</option>
            <option value="leastVotes">Least Votes</option>
        </select>
    </div>

    <table>
        <tr>
            <th>Title</th>
            <th>Content</th>
            <th>User</th>
            <th>Posted</th>
            <th colspan="3">Votes</th>
        </tr>
        @foreach (var post in posts)
        {
            <tr>
                <td><a href="/post/@post.Id">@post.Title</a></td>
                <td>@post.Content</td>
                <td>@post.User</td>
                <td>@FormatTimeSince(post.CreatedAt)</td>
                <td>@(post.Upvotes - post.Downvotes)</td>
                <td><button @onclick="() => Upvote(post.Id)">Upvote</button></td>
                <td><button @onclick="() => Downvote(post.Id)">Downvote</button></td>
            </tr>
        }
    </table>
}

@code {
    private Post[]? posts;
    private string? newPostTitle;
    private string? newPostContent;
    private string? newPostUser;
    private string selectedSortOption = "newest"; // Standard sorteringsmulighed

    protected override async Task OnInitializedAsync()
    {
        await LoadPosts();
    }

    private async Task LoadPosts()
    {
        posts = (await apiService.GetPosts()).ToArray();
        SortPosts(); // Sorter posts, når de indlæses
    }

    private void OnSortOptionChanged(ChangeEventArgs e)
    {
        selectedSortOption = e.Value.ToString();
        SortPosts();
    }

    private void SortPosts()
    {
        if (posts == null) return; // Tjek, at posts ikke er null

        switch (selectedSortOption)
        {
            case "mostVotes":
                posts = posts.OrderByDescending(p => (p.Upvotes - p.Downvotes)).ToArray();
                break;
            case "leastVotes":
                posts = posts.OrderBy(p => (p.Upvotes - p.Downvotes)).ToArray();
                break;
            case "newest":
            default:
                posts = posts.OrderByDescending(p => p.CreatedAt).ToArray();
                break;
        }
    }

    private async Task CreatePost()
    {
        if (string.IsNullOrWhiteSpace(newPostTitle) ||
            string.IsNullOrWhiteSpace(newPostContent) ||
            string.IsNullOrWhiteSpace(newPostUser))
        {
            return;
        }

        var newPost = await apiService.CreatePost(newPostTitle, newPostContent, newPostUser);
        if (newPost != null)
        {
            await LoadPosts(); // Opdater listen med indlæg
            ClearPostInputs();
        }
    }

    private async Task Upvote(int id)
    {
        await apiService.UpvotePost(id);
        await LoadPosts(); // Opdater listen
    }

    private async Task Downvote(int id)
    {
        await apiService.DownvotePost(id);
        await LoadPosts(); // Opdater listen
    }

    private void ClearPostInputs()
    {
        newPostTitle = "";
        newPostContent = "";
        newPostUser = "";
    }

    private string FormatTimeSince(DateTime createdAt)
    {
        var timeSpan = DateTime.Now - createdAt;

        if (timeSpan.TotalDays >= 1)
        {
            return $"{(int)timeSpan.TotalDays} days ago";
        }
        else if (timeSpan.TotalHours >= 1)
        {
            return $"{(int)timeSpan.TotalHours} hours ago";
        }
        else
        {
            return $"{(int)timeSpan.TotalMinutes} minutes ago";
        }
    }
}
